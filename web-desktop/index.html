<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />

        <title>Cocos Creator | Dandelion</title>

        <meta
            name="viewport"
            content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1,minimal-ui=true"
        />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="full-screen" content="yes" />
        <meta name="screen-orientation" content="landscape" />
        <meta name="x5-fullscreen" content="true" />
        <meta name="360-fullscreen" content="true" />

        <meta name="renderer" content="webkit" />
        <meta name="force-rendering" content="webkit" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

        <link rel="stylesheet" type="text/css" href="./style.css" />
        <link rel="icon" href="favicon.ico" />
        <style>
            #toolbar {
                position: absolute;
                top: 10px;
                left: 10px;
                z-index: 9999;
                background: rgba(255, 255, 255, 0.9);
                padding: 10px;
                border-radius: 8px;
                font-size: 14px;
            }
            #jsonInput {
                width: 300px;
                height: 100px;
            }
            button {
                margin-top: 6px;
                display: block;
            }
        </style>

        <!-- 注入 JS 中读取的 window.__currentTestLevel__ -->
        <script>
            window.__currentTestLevel__ = null;

            function loadJsonAndReload(content) {
                try {
                    const json = JSON.parse(content);
                    window.__currentTestLevel__ = json;
                    localStorage.setItem("__lastTestLevel__", content);
                    location.reload();
                } catch (e) {
                    alert("❌ JSON 格式错误！");
                }
            }

            const saved = localStorage.getItem("__lastTestLevel__");
            if (saved) {
                try {
                    window.__currentTestLevel__ = JSON.parse(saved);
                } catch (e) {
                    console.warn("无法解析上次测试数据");
                }
            }
        </script>
    </head>
    <body>
        <div id="toolbar">
            <strong>粘贴或上传 JSON</strong><br />
            <textarea id="jsonInput" placeholder="粘贴关卡 JSON..."></textarea>
            <button
                onclick="loadJsonAndReload(document.getElementById('jsonInput').value)"
            >
                ▶️ 加载并试玩
            </button>
            <input type="file" id="fileInput" />
        </div>

        <div
            id="GameDiv"
            cc_exact_fit_screen="false"
            style="width: 100vw; height: 100vh"
        >
            <div id="Cocos3dGameContainer">
                <canvas id="GameCanvas" tabindex="99"></canvas>
            </div>
        </div>
        <!-- Polyfills bundle. -->

        <script src="src/polyfills.bundle.js" charset="utf-8"></script>

        <!-- SystemJS support. -->
        <script src="src/system.bundle.js" charset="utf-8"></script>

        <!-- Import map -->
        <script
            src="src/import-map.json"
            type="systemjs-importmap"
            charset="utf-8"
        ></script>

        <script>
            System.import("./index.js").catch(function (err) {
                console.error(err);
            });
        </script>

        <script>
            document
                .getElementById("fileInput")
                .addEventListener("change", function (e) {
                    const reader = new FileReader();
                    reader.onload = function () {
                        loadJsonAndReload(reader.result);
                    };
                    reader.readAsText(e.target.files[0]);
                });
        </script>
    </body>
</html>
